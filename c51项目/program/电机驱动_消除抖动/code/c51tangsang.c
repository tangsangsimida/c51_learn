
#include "c51tangsang.h"

/*
 *????tangsang????????????????????????????ÓR?????????¦Ï? 
 *????tangsang????????????????????????????ÓR?????????¦Ï? 
 *????tangsang????????????????????????????ÓR?????????¦Ï? 
 */



//???????
//unsigned int ms??????¦Ë???? 
void delay(unsigned int ms)
{
	unsigned char i, j;
	while(ms--)
	{	
		i = 12;
		j = 169;
		do
		{
			while (--j);
		} while (--i);
	}
}
//??¦Ë????????¦Ë?????????
//??????????????????????????or DIY??? 
void show_digital(unsigned int th,unsigned int digital)
{
	//??????????????????????????????????????????????
	//?????????????????????§Ø?????????????ÕÇ??????????????????????ÕÇ?????????????????????????????????¡À????
	//???????????????????????????????????
	//??????????????????????? 
	//0-9 
	unsigned char code digital_table[]={0xc0,0xf9,0xa4,0xb0, 
										0x99,0x92,0x82,0xf8,
										0x80,0x90,0x88,0x83,
										0xc6,0xa1,0x86,0x8e};
	switch(th)
	{																		//    P2_4 P2_3 P2_2
		case 8:P2_2=0;P2_3=0;P2_4=0;break;// 1. 1			1 		1
		case 4:P2_2=0;P2_3=0;P2_4=1;break;// 2. 1			1			0
		case 6:P2_2=0;P2_3=1;P2_4=0;break;// 3. 1 		0 		1
		case 2:P2_2=0;P2_3=1;P2_4=1;break;// 4. 1 		0 		0
		case 7:P2_2=1;P2_3=0;P2_4=0;break;// 5. 0 		1 		1
		case 3:P2_2=1;P2_3=0;P2_4=1;break;// 6. 0 		1 		0
		case 5:P2_2=1;P2_3=1;P2_4=0;break;// 7. 0 		0 		1
		case 1:P2_2=1;P2_3=1;P2_4=1;break;// 8. 0 		0 		0
		//??????????1????
		default:P2_2=0;P2_3=0;P2_4=0;P0=digital_table[digital];
	}
	//??????????¨¿????????????????????????§Õ???????????????????¨¿????? ???????
	P0=~digital_table[digital];
	delay(1);
	//??????
	
}

static void write_byte(unsigned char byte)
{
	unsigned char i;
	//?????????????????????????¦Ë?????????????& |??????
	for(i=0;i<8;i++)
	{
		//?????¦Ë?????
		SER =byte>>7;
		byte<<=1;
		//????rck??????
		SRCK =0;
		SRCK =1;
	}
	//??????????????????????
	RCK =1;
	//???????????io??????????????¦Ä????????????(???????????)
	RCK =0;
}


void show_clum(unsigned char clum,unsigned char Data)
{
	write_byte(Data);
	P0=~(0x80>>(clum-1));
	//???????????0???
}

//???????????¦Ë??us
void delayus(unsigned int j)		//@12.000MHz
{
	unsigned char i;
	while(j--)
	{
		i = 2;
		while (--i);
	}
}

// uint i --->?????????????????
void beep(uint i)
{
		while(i--)
		{
			P2_5=0;
			delayus(20);//???????????????????????????????
			P2_5=1;
			delayus(10);
		}
}
void time_0_ms_init()
{
	//TMOD = 0x01;//????????????¦Ë????????¦Ë???????????ÈÉ
	TMOD&=0xF0;//?????§Õ???????????????????????????????
	TMOD|=0x01;//??&|??????????????????????????????
	TF0=0;//????????0?????¨°??????????????????§Ø?;
	TH0=64535/256;//???¦Ë????     ????12mhz??????????1us?????65535us??
	TL0=64535%256;//???¦Ë????->64535 = 65535-1000; -> 1000us=1ms; ???????¦Ë?1ms
	ET0=1;//?????§Ø???????
	EA=1;
	PT0=0;
	TR0=1;//??????????????
}

void time_1_ms_init()
{
	TMOD&=0x0F;
	TMOD|=0x10;
	TL1=64535%256;
	TH1=64535/256;
	TF1=0;//????????¦Ä???	

//	IE1=1;//?§Ø????
//	IT1=1;
	
	ET1=1;//?????§Ø???????
	EA=1;
	PT1=0;
	
	TR1=1;//?????1???????
}

void time_1_us_init()
{
	TMOD&=0x0F;
	TMOD|=0x10;
	TL1=65534%256;
	TH1=65534/256;
	TF1=0;//????????¦Ä???	

//	IE1=1;//?§Ø????
//	IT1=1;
	
	ET1=1;//?????§Ø???????
	EA=1;
	PT1=0;
	
	TR1=1;//?????1???????
}

void time_0_us_init()
{
	//TMOD = 0x01;//????????????¦Ë????????¦Ë???????????ÈÉ
	TMOD&=0xF0;//?????§Õ???????????????????????????????
	TMOD|=0x01;//??&|??????????????????????????????
	TF0=0;//????????0?????¨°??????????????????§Ø?;
	TH0=65534/256;//???¦Ë????     ????12mhz??????????1us?????65535us??
	TL0=65534%256;//???¦Ë????->64535 = 65535-1000; -> 1000us=1ms; ???????¦Ë?1ms
	ET0=1;//?????§Ø???????
	EA=1;
	PT0=0;
	TR0=1;
}

//?????????????
unsigned int buttom_getstate_4()
{
	if(P3_0==0)
	{
		delay(20);while(P3_0==0);delay(20);return 2;
	}
	if(P3_1==0)
	{
		delay(10);while(P3_1==0);delay(20);return 1;
	}
	if(P3_2==0)
	{
		delay(10);while(P3_2==0);delay(20);return 3;
	}
	if(P3_3==0)
	{
		delay(10);while(P3_3==0);delay(20);return 4;
	}
	return 0;
}

int buttom_getstate_16()
{
    int state=0;
    P1=0xFF;
    //???P1?????1?????????io??0??????§Ø?
    P1_3=0;
    //???????????--->?§Ø????????
    if(P1_7==0){ delay(50);while(P1_7==0);delay(20);state=1;}
    if(P1_6==0){ delay(50);while(P1_7==0);delay(20);state=5;}
    if(P1_5==0){ delay(50);while(P1_7==0);delay(20);state= 9;}
    if(P1_4==0){ delay(50);while(P1_7==0);delay(20);state= 13;}

    P1=0xFF;
    //???P1?????1?????????io??0??????§Ø?
    P1_2=0;
    //???????????--->0100
    if(P1_7==0){ delay(20);while(P1_7==0);delay(20);state= 2;}
    if(P1_6==0){ delay(20);while(P1_7==0);delay(20);state= 6;}
    if(P1_5==0){ delay(20);while(P1_7==0);delay(20);state= 10;}
    if(P1_4==0){ delay(20);while(P1_7==0);delay(20);state= 14;}

    P1=0xFF;
    //???P1?????1?????????io??0??????§Ø?
    P1_1=0;
    //???????????--->0010
    if(P1_7==0){ delay(20);while(P1_7==0);delay(20);state= 3;}
    if(P1_6==0){ delay(20);while(P1_7==0);delay(20);state= 7;}
    if(P1_5==0){ delay(20);while(P1_7==0);delay(20);state= 11;}
    if(P1_4==0){ delay(20);while(P1_7==0);delay(20);state= 15;}

    P1=0xFF;
    //???P1?????1?????????io??0??????§Ø?
    P1_0=0;
    //???????????--->0001
    if(P1_7==0){ delay(20);while(P1_7==0);delay(20);state= 4;}
    if(P1_6==0){ delay(20);while(P1_7==0);delay(20);state= 8;}
    if(P1_5==0){ delay(20);while(P1_7==0);delay(20);state= 12;}
    if(P1_4==0){ delay(20);while(P1_7==0);delay(20);state= 16;}

    return state;
}
//4800?????????????
void uart_init()		//4800bps@11.0592MHz
{
    PCON &= 0x7F;		//???????????
    SCON = 0x50;		//8¦Ë????,???????
//    AUXR &= 0xBF;		//?????1????Fosc/12,??12T
//    AUXR &= 0xFE;		//????1??????1????????????
    TMOD &= 0x0F;		//????????1??¦Ë
    TMOD |= 0x20;		//?Ú…?????1?8¦Ë?????????
    TL1 = 0xFA;		//?Ú…??????
    TH1 = 0xFA;		//?Ú…?????????
    ET1 = 0;		//????????1?§Ø?
    TR1 = 1;		//?????????1
    EA = 1;    //?????????§Ø?
    ES = 1;    //?????????§Ø?
}

//?????????????
void uart_sendbyte(unsigned char byte)
{
    SBUF=byte;
    while(TI==0);
    TI=0;
}

void uart_getdata() interrupt 4
{
    if(RI==1)//??????????????????§Ø?
    {
        RI=0;//?????????§Ø????
        date_uart=SBUF;//????????
    }
}
//uart????????